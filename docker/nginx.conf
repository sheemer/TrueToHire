worker_processes auto;

events {
    worker_connections 4096;
}

http {

    # Optional but useful: real client IP support if behind Cloudflare
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    # Cloudflare IPs for real client detection
    #set_real_ip_from 103.21.244.0/22;
    #set_real_ip_from 103.22.200.0/22;
    #set_real_ip_from 103.31.4.0/22;
    #set_real_ip_from 104.16.0.0/13;
    #set_real_ip_from 104.24.0.0/14;
    #set_real_ip_from 108.162.192.0/18;
    #set_real_ip_from 131.0.72.0/22;
    #set_real_ip_from 141.101.64.0/18;
    #set_real_ip_from 162.158.0.0/15;
    #set_real_ip_from 172.64.0.0/13;
    #set_real_ip_from 173.245.48.0/20;
    #set_real_ip_from 188.114.96.0/20;
    #set_real_ip_from 190.93.240.0/20;
    #set_real_ip_from 197.234.240.0/22;
    #set_real_ip_from 198.41.128.0/17;

    real_ip_header CF-Connecting-IP;
    real_ip_recursive on;

    upstream django {
        server web:8000;
    }

    upstream guacamole {
        server guacamole:8080;
    }

    client_max_body_size 100M;

    # Redirect HTTP to HTTPS
    #    server {
	   #listen 80;
	#server_name ;
	#return 301 https://$host$request_uri;
    #}

    server {
        listen 443 ssl;
	# behind this make sure to add the site name like truetohire.com
	#server_name ;
        include /etc/nginx/mime.types;
	
	ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
	ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;
	proxy_connect_timeout 300;
	proxy_send_timeout 300;
	proxy_read_timeout 300;
	send_timeout 300;

        error_page 404 /errors/404.html;
        error_page 500 502 503 504 /errors/500.html;
        error_page 403 /errors/403.html;

        location /errors/ {
            root /home/timango/app/error/;
            internal;
        }
	# where it says truetohire replace with your name as well uncomment most of the other stuff
	#ssl_certificate /etc/letsencrypt/live/truetohire.com/fullchain.pem;
	# ssl_certificate_key /etc/letsencrypt/live/truetohire.com/privkey.pem;
	#ssl_protocols TLSv1.2 TLSv1.3;
	#ssl_prefer_server_ciphers on;
	#ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305";
	#ssl_session_cache shared:SSL:10m;
	#ssl_session_timeout 10m;
	#ssl_stapling on;
	#ssl_stapling_verify on;
	#resolver 8.8.8.8 8.8.4.4 valid=300s;
	#resolver_timeout 5s;

        if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|OPTIONS)$) {
             return 444;
        }

        server_tokens off;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
	#you can put your name in a lot of the following would clean up somethings
        add_header Content-Security-Policy "default-src 'self'; media-src 'self'; script-src 'self'; style-src 'self'; frame-src 'self'; connect-src 'self'; img-src 'self'; font-src 'self';" always;

        location = / {
            return 301 /home;
        }

        location / {
            proxy_pass http://django;
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            #add_header X-Frame-Options SAMEORIGIN;
            add_header X-XSS-Protection "1; mode=block";
            add_header X-Content-Type-Options nosniff;

       
            limit_req zone=django_only burst=20 nodelay;
            #add_header 'Referrer-Policy' 'origin';
            add_header X-XSS-Protection "1; mode=block" always;
            add_header X-Content-Type-Options nosniff always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;
            add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "";
            proxy_set_header Authorization $http_authorization;
        }

        location = /admin {
		#you don't need to but you could block off the admin page from a lot of people I would but.
	}


        location /static/ {
            alias /home/timango/app/staticfiles/;
            autoindex on;
            expires off;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        }
    }

       # Guacamole Server Block
      # Guacamole Server Block
    server {
        listen 8443;
	#same as before please replace name and remove # 	
	#server_name guac.truetohire.com;
	#ssl_certificate /etc/letsencrypt/live/guac.truetohire.com/fullchain.pem;
	#ssl_certificate_key /etc/letsencrypt/live/guac.truetohire.com/privkey.pem;
	#ssl_protocols TLSv1.2 TLSv1.3;
	#ssl_ciphers HIGH:!aNULL:!MD5;

        error_page 404 /errors/404.html;
        error_page 500 502 503 504 /errors/500.html;
        error_page 403 /errors/403.html;

        location /errors/ {
            root /home/timango/app/error/;
            internal;
        }

        if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|OPTIONS)$) {
            return 444;
        }

    # replace name with main site name
        add_header 'Access-Control-Allow-Origin' 'https://truetohire.com' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, Guacamole-Tunnel-Token' always;
        add_header 'Access-Control-Expose-Headers' 'Guacamole-Tunnel-Token, Guacamole-Status-Code, Guacamole-Error-Message, Guacamole-Error-Code, Content-Length' always;

        location /guacamole/tunnel {
        # same replace here 
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'https://truetohire.com' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, Guacamole-Tunnel-Token' always;
                add_header 'Access-Control-Expose-Headers' 'Guacamole-Tunnel-Token, Guacamole-Status-Code, Guacamole-Error-Message, Guacamole-Error-Code, Content-Length' always;
                add_header Content-Length 0;
                add_header Content-Type 'text/plain; charset=UTF-8';
                return 204;
            }
          
            proxy_pass http://guacamole/guacamole/tunnel;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-Guacamole-Token $http_x_guacamole_token;

            proxy_buffering off;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        location /guacamole/ {
		#replace name
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'https://truetohire.com' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, Guacamole-Tunnel-Token' always;
                add_header 'Access-Control-Expose-Headers' 'Guacamole-Tunnel-Token, Guacamole-Status-Code, Guacamole-Error-Message, Guacamole-Error-Code, Content-Length' always;
                add_header Content-Length 0;
                add_header Content-Type 'text/plain; charset=UTF-8';
                return 204;
                
            }
            allow #your ip;
            allow #your Ip;
            deny all;
            proxy_pass http://guacamole/guacamole/;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-Guacamole-Token $http_x_guacamole_token;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffering off;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        location / {
		#replace name
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' 'https://truetohire.com' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, Guacamole-Tunnel-Token' always;
                add_header 'Access-Control-Expose-Headers' 'Guacamole-Tunnel-Token, Guacamole-Status-Code, Guacamole-Error-Message, Guacamole-Error-Code, Content-Length' always;
                add_header Content-Length 0;
                add_header Content-Type 'text/plain; charset=UTF-8';
                return 204;
                
            }
            proxy_pass http://guacamole/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-Guacamole-Token $http_x_guacamole_token;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }
    }

# Separate rate limiting zone for Django only
limit_req_zone $binary_remote_addr zone=django_only:10m rate=10r/s;

}
